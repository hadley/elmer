<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Prompt design • elmer</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prompt design">
<script defer data-domain="elmer.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">elmer</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/elmer.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/prompt-design.html">Prompt design</a></li>
    <li><a class="dropdown-item" href="../articles/streaming-async.html">Streaming and async APIs</a></li>
    <li><a class="dropdown-item" href="../articles/structured-data.html">Structured data</a></li>
    <li><a class="dropdown-item" href="../articles/tool-calling.html">Tool/function calling</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/elmer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Prompt design</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/elmer/blob/main/vignettes/prompt-design.Rmd" class="external-link"><code>vignettes/prompt-design.Rmd</code></a></small>
      <div class="d-none name"><code>prompt-design.Rmd</code></div>
    </div>

    
    
<p>This vignette will give you some advice about the logistics of
writing prompts with elmer, and then work through two hopefully relevant
examples showing how you might write a prompt when generating code and
when extracting structured data. If you’ve never written a prompt
before, I’d highly recommend reading <a href="https://www.oneusefulthing.org/p/getting-started-with-ai-good-enough" class="external-link">Getting
started with AI: Good enough prompting</a> by Ethan Mollick. I think his
motivating analogy does a really good job of getting you started:</p>
<blockquote>
<p>Treat AI like an infinitely patient new coworker who forgets
everything you tell them each new conversation, one that comes highly
recommended but whose actual abilities are not that clear. … Two parts
of this are analogous to working with humans (being new on the job and
being a coworker) and two of them are very alien (forgetting everything
and being infinitely patient). We should start with where AIs are
closest to humans, because that is the key to good-enough prompting</p>
</blockquote>
<p>As well as learning general prompt design skills, it’s also a good
idea to read any specific advice for the model that you’re using. Here
are some pointers to the prompt design guides some of the most popular
models:</p>
<ul>
<li><a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview" class="external-link">Claude</a></li>
<li><a href="https://platform.openai.com/docs/guides/prompt-engineering" class="external-link">OpenAI</a></li>
<li><a href="https://ai.google.dev/gemini-api/docs/prompting-intro" class="external-link">Gemini</a></li>
</ul>
<p>If you have a claude account, you can use its <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/prompt-generator" class="external-link uri">https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/prompt-generator</a>.
This prompt generator has been specifically tailored for Claude, but I
suspect it will help many other LLMs, or at least give you some ideas as
to what else you might want to include in your prompt.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://elmer.tidyverse.org">elmer</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="logistics">Logistics<a class="anchor" aria-label="anchor" href="#logistics"></a>
</h2>
<p>There are a few logistics to discuss first. It’s highly likely that
you will end up writing long, possibly multi-page prompts, so we want to
ensure that you’re set up for success. We recommend that you put each
prompt in its own file, and write them using markdown. LLMs, like
humans, appear to find markdown to be quite readable and markdown allows
you to (e.g.) use headers to divide up the prompt into esection, and
other tools like itemised lists to enumerate multiple options. You can
see some a few examples of this style of prompt here:</p>
<ul>
<li><a href="https://github.com/posit-dev/shiny-assistant/blob/main/shinyapp/app_prompt_python.md" class="external-link uri">https://github.com/posit-dev/shiny-assistant/blob/main/shinyapp/app_prompt_python.md</a></li>
<li><a href="https://github.com/jcheng5/py-sidebot/blob/main/prompt.md" class="external-link uri">https://github.com/jcheng5/py-sidebot/blob/main/prompt.md</a></li>
<li><a href="https://github.com/simonpcouch/pal/tree/main/inst/prompts" class="external-link uri">https://github.com/simonpcouch/pal/tree/main/inst/prompts</a></li>
<li><a href="https://github.com/cpsievert/aidea/blob/main/inst/app/prompt.md" class="external-link uri">https://github.com/cpsievert/aidea/blob/main/inst/app/prompt.md</a></li>
</ul>
<p>In terms of file names, if you only have one prompt in your project,
call it <code>prompt.md</code>. If you have multiple prompts, give them
informative names like <code>prompt-extract-metadata.md</code> or
<code>prompt-summarize-text.md</code>. If you’re writing a package, put
your prompt(s) in <code>inst/prompts</code>, otherwise it’s fine to put
them in the root directory of your project.</p>
<p>Your prompts are going to change over time, so we highly recommend
commiting them to a git repo. That will ensure that you can easily see
what has changed, and if you accidentally make a mistake you can easily
roll back to a known good verison.</p>
<p>If your prompt includes dynamic data, use
<code><a href="../reference/interpolate.html">elmer::interpolate_file()</a></code> to interpolate it into your
prompt. <code><a href="../reference/interpolate.html">interpolate_file()</a></code> works like <a href="https://glue.tidyverse.org" class="external-link">glue</a>, but uses <code>{{ }}</code>
instead of <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{ }</a></code> to make it easier to work with JSON.</p>
<p>As you iterate on the prompt, it’s a good idea to build up a small
set of challenging examples that you can regularly re-check with your
latest version of the prompt. Currently you’ll need to do this by hand,
but we hope to eventually also provide tools that help you do this a
little more formally.</p>
<p>Unfortunately, however, you won’t see these logistics in action in
this vignette, since we’re keeping the prompts short and inline to make
it easier for you to grok what’s going on.</p>
</div>
<div class="section level2">
<h2 id="code-generation">Code generation<a class="anchor" aria-label="anchor" href="#code-generation"></a>
</h2>
<p>Let’s explore prompt design for a simple code generation task:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">question</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  How can I compute the mean and median of variables a, b, c, and so on,</span></span>
<span><span class="st">  all the way up to z, grouped by age and sex.</span></span>
<span><span class="st">"</span></span></code></pre></div>
<p>I’ll use <code><a href="../reference/chat_claude.html">chat_claude()</a></code> for this problem because in our
experience it does the best job of generating code.</p>
<div class="section level3">
<h3 id="basic-flavour">Basic flavour<a class="anchor" aria-label="anchor" href="#basic-flavour"></a>
</h3>
<p>When I don’t provide a system prompt, I sometimes get answers in a
different languages or different styles of R code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
<p>I can ensure that I always get R code in a given style by providing a
system prompt:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R programmer who prefers the tidyverse.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
<p>Note that I’m using both a system prompt (which defines the general
behaviour) and a user prompt (which askes the specific question). You
could put all of the content in the user prompt and get similar results,
but I think it’s helpful to use both to cleanly divide the general
framing of the response from the specific questions that you want to
ask.</p>
<p>Since I’m mostly interested in the code, I ask it to drop the
explanation and the sample data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R programmer who prefers the tidyverse.</span></span>
<span><span class="st">  Just give me the code. I don't want any explanation or sample data.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
<p>And of course, if you want a different style of R code, you can of
course ask for it:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R programmer who prefers data.table.</span></span>
<span><span class="st">  Just give me the code. I don't want any explanation or sample data.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R programmer who prefers base R.</span></span>
<span><span class="st">  Just give me the code. I don't want any explanation or sample data.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="be-explicit">Be explicit<a class="anchor" aria-label="anchor" href="#be-explicit"></a>
</h3>
<p>If there’s something about the output that you don’t like, you can
try being more explicit about it. For example, the code isn’t styled
quite how I like, so I provide more details about what I do want:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R programmer who prefers the tidyverse.</span></span>
<span><span class="st">  Just give me the code. I don't want any explanation or sample data.</span></span>
<span><span class="st"></span></span>
<span><span class="st">  Follow the tidyverse style guide:</span></span>
<span><span class="st">  * Spread long function calls across multiple lines.</span></span>
<span><span class="st">  * Where needed, always indent function calls with two spaces.</span></span>
<span><span class="st">  * Only name arguments that are less commonly used.</span></span>
<span><span class="st">  * Always use double quotes for strings.</span></span>
<span><span class="st">  * Use the base pipe, `|&gt;`, not the magrittr pipe `%&gt;%`.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
<p>This still doesn’t yield exactly the code that I’d write, but it’s
prety close.</p>
<p>You could provide a different prompt if you were looking for more
explanation of the code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R teacher.</span></span>
<span><span class="st">  I am a new R user who wants to improve my programming skills.</span></span>
<span><span class="st">  Help me understand the code you produce by explaining each function call with</span></span>
<span><span class="st">  a brief comment. For more complicated calls, add documentation to each</span></span>
<span><span class="st">  argument. Just give me the code. I don't want any explanation or sample data.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="teach-it-about-new-features">Teach it about new features<a class="anchor" aria-label="anchor" href="#teach-it-about-new-features"></a>
</h3>
<p>You can imagine LLMs as being a sort of an average of the internet at
a given point in time. That means they will provide popular answers,
which will tend to reflect older coding styles (either because the new
features aren’t in their index, or the older features are so much more
popular). So if you want your code to use specific features that are
relatively recent, you might need to provide the examples yourself:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_claude.html">chat_claude</a></span><span class="op">(</span>system_prompt <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  You are an expert R programmer.</span></span>
<span><span class="st">  Just give me the code; no explanation in text.</span></span>
<span><span class="st">  Use the `.by` argument rather than `group_by()`.</span></span>
<span><span class="st">  dplyr 1.1.0 introduced per-operation grouping with the `.by` argument.</span></span>
<span><span class="st">  e.g., instead of:</span></span>
<span><span class="st"></span></span>
<span><span class="st">  transactions |&gt;</span></span>
<span><span class="st">    group_by(company, year) |&gt;</span></span>
<span><span class="st">    mutate(total = sum(revenue))</span></span>
<span><span class="st"></span></span>
<span><span class="st">  write this:</span></span>
<span><span class="st">  transactions |&gt;</span></span>
<span><span class="st">    mutate(</span></span>
<span><span class="st">      total = sum(revenue),</span></span>
<span><span class="st">      .by = c(company, year)</span></span>
<span><span class="st">    )</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">question</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="structured-data">Structured data<a class="anchor" aria-label="anchor" href="#structured-data"></a>
</h2>
<p>Providing a rich set of examples is a great way to encourage the
output to produce exactly what you want. This is also known as
<strong>multi-shot prompting</strong>. Here we’ll work through a prompt
that I designed to extract structured data from recipes, but the same
ideas apply in many other situations.</p>
<div class="section level3">
<h3 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h3>
<p>My overall goal is to turn a list of ingredients, like the following,
into a nicely structured JSON that I can then analyse in R (e.g. to
compute the total weight, scale the recipe up or down, or to convert the
units from volumes to weights).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ingredients</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  ¾ cup (150g) dark brown sugar</span></span>
<span><span class="st">  2 large eggs</span></span>
<span><span class="st">  ¾ cup (165g) sour cream</span></span>
<span><span class="st">  ½ cup (113g) unsalted butter, melted</span></span>
<span><span class="st">  1 teaspoon vanilla extract</span></span>
<span><span class="st">  ¾ teaspoon kosher salt</span></span>
<span><span class="st">  ⅓ cup (80ml) neutral oil</span></span>
<span><span class="st">  1½ cups (190g) all-purpose flour</span></span>
<span><span class="st">  150g plus 1½ teaspoons sugar</span></span>
<span><span class="st">"</span></span></code></pre></div>
<p>(This isn’t the ingredient list for a real recipe but it includes a
sampling of styles that I encountered in my project.)</p>
<p>If you don’t have strong feelings about what the data structure
should look like, you can start with a very loose prompt and see what
you get back. I find this a useful pattern for underspecified problems
where a big part of the problem is just defining precisely what problem
you want to solve. Seeing the LLM’s attempt at a data structure gives me
something to immediately react to, rather than having to start from a
blank page.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">instruct_json</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  You're an expert baker who also loves JSON. I am going to give you a list of</span></span>
<span><span class="st">  ingredients and your job is to return nicely structured JSON. Just return the</span></span>
<span><span class="st">  JSON and no other commentary.</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span><span class="va">instruct_json</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">ingredients</span><span class="op">)</span></span></code></pre></div>
<p>(I don’t know if the colour text, “You’re an expert baker who also
loves JSON”, does anything, but I like to think this helps the LLM get
into the right mindset of a very nerdy baker.)</p>
</div>
<div class="section level3">
<h3 id="provide-examples">Provide examples<a class="anchor" aria-label="anchor" href="#provide-examples"></a>
</h3>
<p>This isn’t a bad start, but I prefer to cook with weight and I only
want to see volumes if weight isn’t available so I provide a couple of
examples of what I’m looking for. I was pleasantly suprised that I can
provide the input and output examples in such a loose format.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">instruct_weight</span> <span class="op">&lt;-</span> <span class="st">r"(</span></span>
<span><span class="st">  Here are some examples of the sort of output I'm looking for:</span></span>
<span><span class="st"></span></span>
<span><span class="st">  ¾ cup (150g) dark brown sugar</span></span>
<span><span class="st">  {"name": "dark brown sugar", "quantity": 150, "unit": "g"}</span></span>
<span><span class="st"></span></span>
<span><span class="st">  ⅓ cup (80ml) neutral oil</span></span>
<span><span class="st">  {"name": "neutral oil", "quantity": 80, "unit": "ml"}</span></span>
<span><span class="st"></span></span>
<span><span class="st">  2 t ground cinnamon</span></span>
<span><span class="st">  {"name": "ground cinnamon", "quantity": 2, "unit": "teaspoon"}</span></span>
<span><span class="st">)"</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">instruct_json</span>, <span class="va">instruct_weight</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">ingredients</span><span class="op">)</span></span></code></pre></div>
<p>Just providing the examples seems to work remarkably well. But I
found it useful to also include description of what the examples are
trying to accomplish. I’m not sure if this helps the LLM or not, but it
certainly makes it easier for me to understand the organisation of the
whole prompt and check that I’ve covered the key pieces that I’m
interested in.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">instruct_weight</span> <span class="op">&lt;-</span> <span class="st">r"(</span></span>
<span><span class="st">  * If an ingredient has both weight and volume, extract only the weight:</span></span>
<span><span class="st"></span></span>
<span><span class="st">  ¾ cup (150g) dark brown sugar</span></span>
<span><span class="st">  [</span></span>
<span><span class="st">    {"name": "dark brown sugar", "quantity": 150, "unit": "g"}</span></span>
<span><span class="st">  ]</span></span>
<span><span class="st"></span></span>
<span><span class="st">* If an ingredient only lists a volume, extract that.</span></span>
<span><span class="st"></span></span>
<span><span class="st">  2 t ground cinnamon</span></span>
<span><span class="st">  ⅓ cup (80ml) neutral oil</span></span>
<span><span class="st">  [</span></span>
<span><span class="st">    {"name": "ground cinnamon", "quantity": 2, "unit": "teaspoon"},</span></span>
<span><span class="st">    {"name": "neutral oil", "quantity": 80, "unit": "ml"}</span></span>
<span><span class="st">  ]</span></span>
<span><span class="st">)"</span></span></code></pre></div>
<p>This structure also allows me to give the LLMs a hint about how I
want multiple ingredients to be stored, i.e. as an JSON array.</p>
<p>I then iterated on the prompt, looking at the results from different
recipes to get a sense of what the LLM was getting wrong. Much of this
felt like I waws iterating on my understanding of the problem as I
didn’t start by knowing exactly how I wanted the data. For example, when
I started out I didn’t really think about all the various ways that
ingredients are specified. For later analysis, I always want quantities
to be number, even if they were originally fractions, or the if the
units aren’t precise (like a pinch). It made me realise that some
ingredients are unitless.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">instruct_unit</span> <span class="op">&lt;-</span> <span class="st">r"(</span></span>
<span><span class="st">* If the unit uses a fraction, convert it to a decimal.</span></span>
<span><span class="st"></span></span>
<span><span class="st">  ⅓ cup sugar</span></span>
<span><span class="st">  ½ teaspoon salt</span></span>
<span><span class="st">  [</span></span>
<span><span class="st">    {"name": "dark brown sugar", "quantity": 0.33, "unit": "cup"},</span></span>
<span><span class="st">    {"name": "salt", "quantity": 0.5, "unit": "teaspoon"}</span></span>
<span><span class="st">  ]</span></span>
<span><span class="st"></span></span>
<span><span class="st">* Quantities are always numbers</span></span>
<span><span class="st"></span></span>
<span><span class="st">  pinch of kosher salt</span></span>
<span><span class="st">  [</span></span>
<span><span class="st">    {"name": "kosher salt", "quantity": 1, "unit": "pinch"}</span></span>
<span><span class="st">  ]</span></span>
<span><span class="st"></span></span>
<span><span class="st">* Some ingredients don't have a unit.</span></span>
<span><span class="st">  2 eggs</span></span>
<span><span class="st">  1 lime</span></span>
<span><span class="st">  1 apple</span></span>
<span><span class="st">  [</span></span>
<span><span class="st">    {"name": "egg", "quantity": 2},</span></span>
<span><span class="st">    {"name": "lime", "quantity": 1},</span></span>
<span><span class="st">    {"name", "apple", "quantity": 1}</span></span>
<span><span class="st">  ]</span></span>
<span><span class="st">)"</span></span></code></pre></div>
<p>You might want to take a look at the <a href="https://gist.github.com/hadley/7688b4dd1e5e97b800c6d7d79e437b48" class="external-link">full
prompt</a> to see what I ended up with.</p>
</div>
<div class="section level3">
<h3 id="structured-data-1">Structured data<a class="anchor" aria-label="anchor" href="#structured-data-1"></a>
</h3>
<p>Now that I’ve iterated to get a data structure that I like, it seems
useful to formalise it and tell the LLM exactly what I’m looking for
using structured data. This guarantees that the LLM will only return
JSON, the JSON will have the fields that you expect, and that elmer will
convert it into an R data structure for you.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type_ingredient</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/type_boolean.html">type_object</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="fu"><a href="../reference/type_boolean.html">type_string</a></span><span class="op">(</span><span class="st">"Ingredient name"</span><span class="op">)</span>,</span>
<span>  quantity <span class="op">=</span> <span class="fu"><a href="../reference/type_boolean.html">type_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="fu"><a href="../reference/type_boolean.html">type_string</a></span><span class="op">(</span><span class="st">"Unit of measurement"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">type_ingredients</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/type_boolean.html">type_array</a></span><span class="op">(</span>items <span class="op">=</span> <span class="va">type_ingredient</span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">instruct_json</span>, <span class="va">instruct_weight</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">$</span><span class="fu">extract_data</span><span class="op">(</span><span class="va">ingredients</span>, type <span class="op">=</span> <span class="fu"><a href="../reference/type_boolean.html">type_object</a></span><span class="op">(</span>ingredients <span class="op">=</span> <span class="va">type_ingredients</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">ingredients</span>, <span class="va">as.data.frame</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="capturing-raw-input">Capturing raw input<a class="anchor" aria-label="anchor" href="#capturing-raw-input"></a>
</h3>
<p>One thing that I’d do next time would also be to include the raw
ingredient name in the output. This doesn’t make much difference here,
in this simple example, but it makes it much easier to align the input
and the output and start to develop automated measures of how well my
prompt is doing.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">instruct_weight_input</span> <span class="op">&lt;-</span> <span class="st">r"(</span></span>
<span><span class="st">  * If an ingredient has both weight and volume, extract only the weight:</span></span>
<span><span class="st"></span></span>
<span><span class="st">    ¾ cup (150g) dark brown sugar</span></span>
<span><span class="st">    [</span></span>
<span><span class="st">      {"name": "dark brown sugar", "quantity": 150, "unit": "g", "input": "¾ cup (150g) dark brown sugar"}</span></span>
<span><span class="st">    ]</span></span>
<span><span class="st"></span></span>
<span><span class="st">  * If an ingredient only lists a volume, extract that.</span></span>
<span><span class="st"></span></span>
<span><span class="st">    2 t ground cinnamon</span></span>
<span><span class="st">    ⅓ cup (80ml) neutral oil</span></span>
<span><span class="st">    [</span></span>
<span><span class="st">      {"name": "ground cinnamon", "quantity": 2, "unit": "teaspoon", "input": "2 t ground cinnamon"},</span></span>
<span><span class="st">      {"name": "neutral oil", "quantity": 80, "unit": "ml", "input": "⅓ cup (80ml) neutral oil"}</span></span>
<span><span class="st">    ]</span></span>
<span><span class="st">)"</span></span></code></pre></div>
<p>I think this is particularly important if you’re working with even
less structured text. For example, imagine you had this text:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recipe</span> <span class="op">&lt;-</span> <span class="st">r"(</span></span>
<span><span class="st">  In a large bowl, cream together one cup of softened unsalted butter and a</span></span>
<span><span class="st">  quarter cup of white sugar until smooth. Beat in an egg and 1 teaspoon of</span></span>
<span><span class="st">  vanilla extract. Gradually stir in 2 cups of all-purpose flour until the</span></span>
<span><span class="st">  dough forms. Finally, fold in 1 cup of semisweet chocolate chips. Drop</span></span>
<span><span class="st">  spoonfuls of dough onto an ungreased baking sheet and bake at 350°F (175°C)</span></span>
<span><span class="st">  for 10-12 minutes, or until the edges are lightly browned. Let the cookies</span></span>
<span><span class="st">  cool on the baking sheet for a few minutes before transferring to a wire</span></span>
<span><span class="st">  rack to cool completely. Enjoy!</span></span>
<span><span class="st">)"</span></span></code></pre></div>
<p>Including the input text in the output makes it easier to see if it’s
doing a good job:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">instruct_json</span>, <span class="va">instruct_weight_input</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">recipe</span><span class="op">)</span></span></code></pre></div>
<p>When I ran it while writing this vignette, it seems to be working out
the weight of the ingredients specified in volume, even though the
prompt specifically asks it not to do that. This may suggest I need to
broaden my examples.</p>
</div>
</div>
<div class="section level2">
<h2 id="token-usage">Token usage<a class="anchor" aria-label="anchor" href="#token-usage"></a>
</h2>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, Joe Cheng, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
